<!DOCTYPE html>
<html>
<head>
    <title>Parking Lot Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .tab {
            display: inline-block;
            margin-right: 10px;
            padding: 10px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .tab.active {
            background-color: #5b63fa;
        }
        .parking-lot {
            position: relative; /* Ensure relative positioning for absolute children */
            width: 570px;
            height: 450px;
            overflow: hidden; /* Ensure no overflow */
            border: 11px solid #000;  /* Optional: to visualize the container boundaries */
        }

        .parking-spot {
            width: 70px; /* Adjust the width as needed */
            height: 90px; /* Adjust the height as needed */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #000;
            border-radius: 5px;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
        }

        .free {
            background-color: rgb(0, 124, 10);
            color: white;
        }

        .occupied {
            background-color: rgb(255, 0, 0);
            color: white;
        }
        .ads-section {
            flex-direction: column;
            align-items: flex-start;
        }
        .ads-section input {
            margin-bottom: 10px;
        }
        .resize-handle {
            width: 10px;
            height: 10px;
            background: #000;
            position: absolute;
            bottom: 0;
            right: 0;
            cursor: se-resize;
        }
    </style>
    <!-- Include jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body>
    <h1>Parking Lot Manager</h1>
    <div id="tabs">
        <!-- Tabs will be dynamically generated here -->
    </div>
    <div id="parkingLot" class="parking-lot">
        <!-- Parking spots will be dynamically generated here -->
    </div>
    <div id="adsSection" class="ads-section">
        <!-- Ads content will be dynamically generated here -->
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, get} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { firebaseConfig } from "./keys/firebaseConfig.js";  // Import the config

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Sign in anonymously
        signInAnonymously(auth)
            .then(() => {
                console.log('Signed in anonymously');
                // Load initial data after signing in
                loadParkingLot(0); // Load the first floor by default
            })
            .catch((error) => {
                console.error('Error signing in anonymously:', error);
            });

        // Function to generate tabs based on floors
        function generateTabs(floors) {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            floors.forEach(floor => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.innerText = `Floor ${floor}`;
                tab.onclick = () => loadParkingLot(floor);
                tabsContainer.appendChild(tab);
            });
            const adsTab = document.createElement('div');
            adsTab.className = 'tab';
            adsTab.innerText = 'Ads';
            adsTab.onclick = loadAds;
            tabsContainer.appendChild(adsTab);
        }

        function generateParkingSpots(floor, data) {
            const parkingLot = document.getElementById('parkingLot');
            parkingLot.innerHTML = '';
            const parkingLotRect = parkingLot.getBoundingClientRect(); // Get container dimensions
            const borderWidth = parseInt(window.getComputedStyle(parkingLot).borderWidth, 10);

            for (let spot in data) {
                if (spot.startsWith('ParkSlot_')) {  // Ensure we only handle parking slots
                    const isTaken = data[spot].taken;
                    const parkingSpot = document.createElement('div');
                    parkingSpot.className = 'parking-spot ' + (isTaken ? 'occupied' : 'free');
                    parkingSpot.innerText = '';
                    parkingSpot.floor_id = floor; // Set floor ID
                    parkingSpot.id = spot; // Set the spot ID

                    // Set initial position from Firebase data
                    const x = Math.min(Math.max(data[spot].position.x, 0), parkingLotRect.width - parkingSpot.offsetWidth); // Ensure x is within bounds
                    const y = Math.min(Math.max(data[spot].position.y, 0), parkingLotRect.height - parkingSpot.offsetHeight); // Ensure y is within bounds
                    parkingSpot.style.position = 'absolute'; // Ensure absolute positioning
                    parkingSpot.style.left = `${x - borderWidth}px`;
                    parkingSpot.style.top = `${y - borderWidth}px`;

                    // Set initial dimentions from Firebase data
                    if (data[spot].Dimensions) {
                        parkingSpot.style.width = `${data[spot].Dimensions.width}px`;
                        parkingSpot.style.height = `${data[spot].Dimensions.height}px`;
                    }

                    const resizeHandle = document.createElement('div');
                    resizeHandle.className = 'resize-handle';
                    parkingSpot.appendChild(resizeHandle);

                    parkingLot.appendChild(parkingSpot);
                    
                    $(parkingSpot).resizable({
                        handles: 'se',
                        containment: ".parking-lot",
                        resize: function(event, ui) {
                            // Use ui.helper instead of ui.element
                            $(ui.helper).css({
                                width: `${ui.size.width}px`,
                                height: `${ui.size.height}px`
                            });
                        }
                    });
                }
            }

            // Make parking spots draggable
            $(".parking-spot").draggable({
                containment: ".parking-lot"
            });
            
        }

        // Function to generate ad section
        function generateAds(adText) {
            const adsSection = document.getElementById('adsSection');
            adsSection.innerHTML = `
                <label for="adInput">Edit Ad:</label>
                <input type="text" id="adInput" value="${adText}" />
                <button onclick="updateAd()">Update Ad</button>
            `;
        }

        // Declare the currentFloor variable to track the current floor
        let currentFloor = 0; // Default to floor 0, change as needed

        // Update the current floor in the loadParkingLot function
        function loadParkingLot(floor) {
            currentFloor = floor; // Update the current floor variable
            const floorRef = ref(database, `floor${floor}`);
            onValue(floorRef, (snapshot) => {
                const data = snapshot.val();
                generateParkingSpots(floor, data);
            });
            // Highlight the active tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[floor].classList.add('active');
            document.getElementById('adsSection').style.display = 'none'; // Hide Ads section
            document.getElementById('parkingLot').style.display = 'flex'; // Show Parking section
            
            document.getElementById('savePositionsButton').style.display = 'flex';
            document.getElementById('clearSlotsButton').style.display = 'flex';
        }

        // Function to load the ad text
        function loadAds() {
            const adRef = ref(database, 'ad');
            onValue(adRef, (snapshot) => {
                generateAds(snapshot.val() || '');
            });
            // Highlight the active tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabs[tabs.length - 1].classList.add('active');
            document.getElementById('parkingLot').style.display = 'none'; // Hide Parking section
            document.getElementById('adsSection').style.display = 'flex'; // Show Ads section
            document.getElementById('savePositionsButton').style.display = 'none';
            document.getElementById('clearSlotsButton').style.display = 'none';
        }

        // Function to update the ad text
        window.updateAd = function() {
            const adInput = document.getElementById('adInput').value;
            const adRef = ref(database, 'ad');
            set(adRef, adInput).then(() => {
                alert('Ad updated successfully!');
            }).catch((error) => {
                console.error("Error updating ad:", error);
            });
        };

        function clearAllSlots() {
            const floors = [0, 1, 2, 3, 4];  // Adjust as needed

            floors.forEach(floor => {
                const floorRef = ref(database, `floor${floor}`);

                // Fetch the data once
                get(floorRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        console.log(`Current data for floor ${floor}:`, data);

                        const updates = {};
                        for (let spot in data) {
                            if (spot.startsWith('ParkSlot_')) {
                                updates[`${spot}/taken`] = false;  // Set the slot to free
                            }
                        }
                        console.log(`Updating floor ${floor} with:`, updates);

                        // Apply the updates to the Firebase database
                        update(floorRef, updates).then(() => {
                            console.log(`All slots on floor ${floor} cleared.`);
                        }).catch((error) => {
                            console.error("Error clearing slots:", error);
                        });
                    } else {
                        console.log(`No data available for floor ${floor}`);
                    }
                }).catch((error) => {
                    console.error("Error fetching data:", error);
                });
            });
        }

        // Set up the button click event handler
        document.getElementById('clearSlotsButton').addEventListener('click', clearAllSlots);

        function getCurrentFloor() {
            return currentFloor; // Return the currently selected floor
        }

        function savePositions() {
            const floor = currentFloor; // Use the currentFloor variable
            const floorRef = ref(database, `floor${floor}`);
            const parkingSpots = document.querySelectorAll('.parking-spot');

            const updates = {};
            parkingSpots.forEach(spot => {
                const id = spot.id; // Use the entire ID directly
                const floor_id = spot.floor_id;

                console.log(`Spot ${id}`);
                console.log(`currentFloor ${currentFloor}`);
                console.log(`floor_id ${floor_id}`);

                if (floor_id === currentFloor) { // Ensure we only update slots for the current floor
                    const rect = spot.getBoundingClientRect();
                    const parkingLotRect = document.getElementById('parkingLot').getBoundingClientRect();
                    const x = rect.left - parkingLotRect.left;
                    const y = rect.top - parkingLotRect.top;

                    const basewidth = parseInt(window.getComputedStyle(spot).width, 10);
                    const baseHeight = parseInt(window.getComputedStyle(spot).height, 10);

                    // Fetch updated dimensions
                    const width = spot.offsetWidth;
                    const height = spot.offsetHeight;

                    updates[`${id}/position`] = { x: Math.round(x), y: Math.round(y) }; // Use 'position' to store coordinates
                    updates[`${id}/Dimensions`] = { width: width, height: height }; // Store dimensions
                    console.log(`Updating floor ${floor_id}, parkslot_${id}`)
                    console.log(`position x = ${x}, y = ${y}`);
                    console.log(`width = ${width}, height = ${height}`);
                }
            });

            update(floorRef, updates).then(() => {
                alert('Positions saved successfully!');
            }).catch((error) => {
                console.error("Error saving positions:", error);
            });
        }

        // Attach the savePositions function to the button
        document.getElementById('savePositionsButton').addEventListener('click', savePositions);

        // Initialize the tabs
        const floors = [0, 1, 2, 3, 4]; // Adjust this array to match the number of floors in your Firebase
        generateTabs(floors);
    </script>

    <button id="savePositionsButton" style="display:none;">Save Positions</button>
    <button id="clearSlotsButton" style="display:none;">Clear All Slots</button>
</body>
</html>